<!DOCTYPE html>
{% extends "backend/base.html" %}
{% import 'bootstrap/wtf.html' as wtf %}
{% from "macro.html" import render_pagination with context %}
{% block head %}
    {{super()}}
{% endblock %}
{% block title %}Edit Blog{% endblock %}
{% block content %}
    <body>
    <div style="padding-bottom: 30px; padding-top: 10px;" class="container" id="content">
        {% include "_flash.html" %}
        <ul class="nav nav-pills" role="tablist">
            <li class="active">
                <a class="nav-link" data-toggle="pill" href="#articleManage">Article Management</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-toggle="pill" href="#typeManage">Category Management</a>
            </li>
        </ul>
        <div class="tab-content">
            <div id="typeManage" class="container tab-pane fade">
                <br>
                <a href="#category" class="btn btn-success" data-toggle="collapse">Add new Category</a>
                <div id="category" class="collapse">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="categoryName">Category:</label>
                            <input class="form-control" id="categoryName" type="text">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <label for="description">Description:</label>
                            <textarea style="width: 100%;height: 50px;" class="form-control" id="description" type="text"></textarea>
                            <br>
                            <button onclick="addCategory()" id="addCategory" class="btn btn-info">Add</button>
                        </div>
                    </div>
                    <hr>
                </div>

                {% if blog_type_datas %}
                    <table class="table table-hover">
                    <caption>Categories</caption>
                    <thead>
                    <tr>
                        <th>Category</th>
                        <th>Created at</th>
                        <th>Articles contained</th>
                        <th>Description</th>
                        <th>Operation</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for data in blog_type_datas %}
                        <tr>
                            <td>{{ data[1] }}</td>
                            <td>{{ data[2] }}</td>
                            <td><span class="label label-success">{{ data[3] }}</span></td>
                            <td>{{ data[4] }}</td>
                            <td>
                                <button class="btn btn-info"><a style="color: white;" href={{ data[5] }}>Edit</a></button>
                                <button id="{{ data[0] }}" onclick="deleteCategory(this.id)" class="btn btn-danger">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                {% endif %}
                </tbody>
                </table>
            </div>
            <div id="articleManage" class="container tab-pane active">
                <br>
                <button class="btn btn-success"><a style="color: white;" href="/backend/admin/blog/create/">Add new Article</a></button>
                <div class="table-responsive">
                    {% if blogs %}
                        <table class="table table-hover">
                        <caption>Articles</caption>
                        <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Introduction</th>
                            <th>Created at</th>
                            <th>Modified at</th>
                            <th>Watches</th>
                            <th>State</th>
                            <th>Operation</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for blog in blogs %}
                            <tr>
                                <td><a href="/blog/article/{{ blog.id }}">{{ blog.title }}</a></td>
                                <td><span class="label label-info">{{ blog.blog_types.name }}</span></td>
                                <td>{{ blog.introduce }}</td>
                                <td>{{ blog.create_time }}</td>
                                <td>{{ blog.update_time }}</td>
                                <td><span class="label label-success">{{ blog.read_times }}</span></td>
                                <td><span class="label label-default">{{ blog.state.name }}</span></td>
                                <td>
                                    <button class="btn btn-info"><a style="color:white; text-decoration: none" href="/backend/blog/edit/{{ blog.id }}">Edit</a></button>
                                    {% if blog.delete_flag != 1 %}
                                        <button class="btn btn-danger"><a style="color:white; text-decoration: none" class="text-info" href="/backend/blog/recover/{{ blog.id }}/">Recover</a></button>
                                    {% else %}
                                        <button class="btn btn-danger"><a style="color:white; text-decoration: none" class="text-info" href="/backend/blog/delete/{{ blog.id }}/">Delete</a></button>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    {% endif %}
                    </tbody>
                    </table>
                </div>
                <div style="margin-right:10px;text-align: right">
                    {{ render_pagination(pagination, align='center') }}
                </div>
            </div>
        </div>
    </div>
    <script>
        function deleteCategory(categoryId){
            $.ajax({
                type: 'POST',
                url: '/backend/deleteCategory',
                data:{"id": categoryId},
                success: function (res){
                    if (res.not_null){
                        alert("Cannot delete category, because it contains articles");
                        return false;
                    }else {
                        alert("Succesfully deleted!");
                        location.reload();
                    }
                }
            })
        }

        function addCategory(){
            let categoryName = $("#categoryName").val();
            let desc = $("#description").val();
            if (categoryName == '' || desc == ''){
                alert("Please fill all info");
                return false;
            }
            $.ajax({
                type:'POST',
                url: '/backend/blog/category/add/',
                data: {"name": categoryName,
                    "desc": desc},
                success: function (res){
                    if (res.is_exists){
                        alert("Category already exists!");
                        return false;
                    }else {
                        alert("Successfully added!");
                        location.reload();
                    }
                }
            })
        }
    </script>
    </body>
{% endblock %}